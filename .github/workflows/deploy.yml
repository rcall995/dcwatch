name: Deploy

on:
  push:
    branches:
      - main
    paths:
      - "web/**"
      - "data/**"
  workflow_dispatch:

# Cancel in-flight deploys when a newer commit lands
concurrency:
  group: deploy
  cancel-in-progress: true

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      # -- 1. Checkout --
      - name: Checkout repo
        uses: actions/checkout@v4

      # -- 2. Setup Node --
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: web/package-lock.json

      # -- 3. Install web dependencies --
      - name: Install dependencies
        working-directory: web
        run: npm ci

      # -- 4. Copy data/ into web/public/data/ before build --
      - name: Copy data files into web public directory
        run: |
          mkdir -p web/public/data
          if [ -d data ] && [ "$(ls -A data 2>/dev/null)" ]; then
            cp -r data/* web/public/data/
          else
            echo "No data directory or empty; skipping copy."
          fi

      # -- 5. Build web frontend --
      - name: Build
        working-directory: web
        run: npm run build

      # -- 6. Deploy to Cloudflare Pages --
      # To use this step, add CLOUDFLARE_API_TOKEN and CLOUDFLARE_ACCOUNT_ID
      # as repository secrets. Create a Pages project named "dc-watcher" first.
      - name: Deploy to Cloudflare Pages
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          command: pages deploy web/dist --project-name=dc-watcher
